name: WordPress Bluehost Sync

on:
  push:
    branches: ["main"]
    paths:
      - "integrations/wordpress/warriors-public-events.php"
      - "integrations/wordpress/warriors-public-events/**"
      - "integrations/wordpress/warriors-theme-tools.php"
      - "integrations/wordpress/warriors-theme-tools/**"
      - ".github/workflows/wordpress-bluehost-sync.yml"
  workflow_dispatch:

jobs:
  deploy-wordpress-assets:
    runs-on: ubuntu-latest
    env:
      BLUEHOST_HOST: ${{ secrets.BLUEHOST_HOST != '' && secrets.BLUEHOST_HOST || vars.BLUEHOST_HOST }}
      BLUEHOST_USER: ${{ secrets.BLUEHOST_USER != '' && secrets.BLUEHOST_USER || vars.BLUEHOST_USER }}
      BLUEHOST_PASS: ${{ secrets.BLUEHOST_PASS != '' && secrets.BLUEHOST_PASS || vars.BLUEHOST_PASS }}
      BLUEHOST_WP_PLUGIN_DIR: ${{ vars.BLUEHOST_WP_PLUGIN_DIR != '' && vars.BLUEHOST_WP_PLUGIN_DIR || 'wp-content/plugins/' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Bluehost credentials are present
        run: |
          test -n "$BLUEHOST_HOST" || (echo "Missing BLUEHOST_HOST in secrets/vars" && exit 1)
          test -n "$BLUEHOST_USER" || (echo "Missing BLUEHOST_USER in secrets/vars" && exit 1)
          test -n "$BLUEHOST_PASS" || (echo "Missing BLUEHOST_PASS in secrets/vars" && exit 1)

      - name: Resolve WordPress plugin directory
        run: |
          if [ -z "$BLUEHOST_WP_PLUGIN_DIR" ]; then
            echo "Missing BLUEHOST_WP_PLUGIN_DIR and no fallback resolved" >&2
            exit 1
          fi

          DEPLOY_DIR="$BLUEHOST_WP_PLUGIN_DIR"
          DEPLOY_DIR="${DEPLOY_DIR#./}"
          DEPLOY_DIR="${DEPLOY_DIR%/}/"

          # Normalize common absolute-path input to FTP root-relative path.
          DEPLOY_DIR="${DEPLOY_DIR#/home2/*/public_html/}"
          DEPLOY_DIR="${DEPLOY_DIR#/home/*/public_html/}"
          DEPLOY_DIR="${DEPLOY_DIR#/public_html/}"

          # Collapse accidental duplication.
          DEPLOY_DIR="${DEPLOY_DIR//public_html\/wp-content\/public_html\/wp-content\//wp-content/}"
          DEPLOY_DIR="${DEPLOY_DIR//wp-content\/wp-content\//wp-content/}"

          # Ensure we only ever deploy into the plugins directory.
          case "$DEPLOY_DIR" in
            wp-content/plugins/*)
              ;;
            *)
              echo "Resolved plugin dir must be under wp-content/plugins/. Got: $DEPLOY_DIR" >&2
              exit 1
              ;;
          esac

          echo "DEPLOY_PLUGIN_DIR=/$DEPLOY_DIR" >> "$GITHUB_ENV"
          echo "Using DEPLOY_PLUGIN_DIR=/$DEPLOY_DIR"

      - name: Upload WordPress plugin folders
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ env.BLUEHOST_HOST }}
          username: ${{ env.BLUEHOST_USER }}
          password: ${{ env.BLUEHOST_PASS }}
          protocol: ftp
          port: 21
          local-dir: integrations/wordpress/
          server-dir: ${{ env.DEPLOY_PLUGIN_DIR }}
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/README.md
            **/*.zip
            **/.DS_Store
          dangerous-clean-slate: false
